apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "drupal-k8s.fullname" . }}-apache-config
  labels:
    {{- include "drupal-k8s.labels" . | nindent 4 }}
data:
  virtualhost.conf: |-
    <VirtualHost *:8080>
      ServerAdmin webmaster@localhost
      DocumentRoot /var/www/html

      <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
      </Directory>

      ErrorLog /dev/stderr

      LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
      CustomLog "/dev/stdout" combined

    {{- if .Values.shield.enabled }}
      # Basic Authentication
      <Location />
        AuthType Basic
        AuthName "Restricted Access"
        AuthUserFile /etc/apache2/.htpasswd
        Require valid-user
      </Location>
    {{- end }}
    </VirtualHost>
  ports.conf: |-
    Listen 8080
{{- if .Values.shield.enabled }}
  .htpasswd: {{ htpasswd .Values.shield.username .Values.shield.password | quote }}
  {{- end}}
